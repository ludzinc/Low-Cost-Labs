<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>LCL: Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="theme/bootstrap.css" media="screen">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="bootstrap/bootstrap.min.js"></script>
  <style>
  .btn-default:active{
      -ms-transform: scale(0.9); /* IE 9 */
      -webkit-transform: scale(0.9); /* Safari */
      transform: scale(0.9);
      transition,0.1s ease;
  }
  </style>

  <script>
    var thisInput = "";

    function requestIO(selectButton, thisType) {
      thisInput = thisType + selectButton;
      console.log("thisInput is", thisInput)
      document.getElementById(thisInput).style.backgroundColor = "#000000";
      var rbutton = setTimeout(buttonReset, 500);
      request = new XMLHttpRequest();
      requestData = "output_" + selectButton;
      console.log("Requesting " + requestData);
      request.open("GET", requestData, true);
      request.send(null);
    }

    function buttonReset() {
      console.log("Resetting focus: " + thisInput);
      document.getElementById(thisInput).blur();
      // location.reload(); // ugly ugly hack - fix focus on last pressed button instead??
    }
  </script>
  <script language="javascript" type="text/javascript">
    //**************************************************************************
    // setup Websockets
    //**************************************************************************
    // var wsUri = 'ws://' + location.hostname + ':81/';
    var wsUri = 'ws://192.168.1.116:81/';
    // var wsUri = 'ws://localhost:80/';
    var output;
    var echo = "";
    var requestMsg = []; // array of messages to be sent out the websocekt.

    function init() {
      console.log("Initiating Home page");
      openWebsocket();
      formatRequest("configButtons");
      formatRequest("configTemperature");
    }
    //**************************************************************************
    // Open Websockets
    // As Websocekts are asynchronous, when first opening messages may be sent
    // to a que to be processed once the readyState is = 1 (opened)
    // this will send all queued messages once the socket is opened.
    //**************************************************************************
    function openWebsocket() {
      var message = "";
      websocket = new WebSocket(wsUri);
      websocket.onopen = function() {
        console.log("Websocket opened.");
        while (requestMsg.length > 0) {
          message = requestMsg.pop();
          console.log("Popping message ", message, " from queue.");
          websocket.send(message);
        }
        console.log("Message queue now empty.");
      }
    }
    //**************************************************************************
    // Query Websockets
    // Take action as required on webSocket
    // Either ques or sends messages based on readyState of the socket
    //**************************************************************************
    function queryWebSocket(request) {
      if (websocket.readyState == 3) {
        console.log("Websocket not open, opening.")
        openWebsocket();
      }
      console.log("Requesting: ", request);
      if (websocket.readyState !== 1) {
        requestMsg.push(request);
        console.log("request pushed to array");
      } else {
        websocket.send(request);
        // check if websocke is open here
        console.log("request sent to websocket");
      }
      // how do i close teh websocet??
      websocket.onclose = function(evt) {
        console.log("Websocket disconnected");
      };
      websocket.onmessage = function(evt) {
        console.log("Websocket message recieved.")
        onMessage(evt);
      };
      websocket.onerror = function(evt) {
        console.log("Websocket Error! " + evt.data);
        document.getElementById("pageStatus").style.color = "red";
        document.getElementById("pageStatus").innerHTML = "Failed to Connect.  Reload to Retry.";
      };
    }

    function onMessage(evt) {
      // change to case / swtich statement later
      var messageRecieved = evt.data;
      var jsonMessage = JSON.parse(messageRecieved);
      console.log("Message Recieved is: " + messageRecieved);
      if (jsonMessage.echo == "configButtons") {
        processButtons(jsonMessage);
        document.getElementById("pageStatus").style.visibility = "hidden";
      } else if (jsonMessage.echo == "configTemperature") {
        // processTemperature(jsonMessage);
        document.getElementById("showTemp").innerHTML = ((jsonMessage.data * jsonMessage.slope) + jsonMessage.intercept) + "&#xb0;" + jsonMessage.mode;
        document.getElementById("showTemp").style.display = "block";
      } else {
        console.log("ERROR: Unknown message recieved.")
      }
    }

    function processButtons(jsonData) {
      var i = 0;
      // document.getElementById("inputLocalName").value = jsonData.LocalName;
      console.log("Button Config Data recived")
      for (i = 0; i < 4; i++) {
        var idname = "b" + (i + 1);
        var idButton = "p" + (i + 1);
        console.log("button index is :", idname);
        console.log("button name is :", jsonData.buttonNames[i]);
        console.log("button show is:", jsonData.show[i]);
        console.log("button mode is:", jsonData.buttonMode[i]);
        document.getElementById(idname).innerHTML = (jsonData.buttonNames[i]);
        if ((jsonData.show[i]) == 1) {
          // document.getElementById(idname).remove();
          document.getElementById(idButton).style.display = "block";
          console.log("showing button ", idname);
        } else {
          document.getElementById(idButton).style.display = "none";
          console.log("hiding button ", idname);
        }
        if ((jsonData.buttonMode[i]) == 1) {
          console.log("option to change look of light button here.  Do later.");
          // set border to yellow, text to yellow
          document.getElementById('b'+(i+1)).style.borderColor = "khaki";
        }
      }
    }

    function formatRequest(requestData) {
      var jsonRequest = JSON.stringify({
        "type": "request",
        "data": requestData
      });
      console.log("Sending Request Data.");
      console.log(jsonRequest);
      // websocket.send(jsonSaveData);
      queryWebSocket(jsonRequest);
    }
    window.addEventListener("load", init, false);
  </script>
</head>

<body>
  <!-- NAVBAR -->
  <div class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <a href="home.html" class="navbar-brand"><span class="fa fa-home"></span></a>
        <a hidden id="showTemp" class="navbar-brand">TEMP&#xb0;C</a>
        <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
      </div>
      <div class="navbar-collapse collapse" id="navbar-main">
        <ul class="nav navbar-nav navbar-right">
          <li><a href="home.html" style="text-align: right">HOME</a></li>
          <li><a href="network.html" style="text-align: right">NETWORK</a></li>
          <li><a href="options.html" style="text-align: right">OPTIONS</a></li>
          <li><a href="calibration.html" style="text-align: right">CALIBRATION</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="container">
    <!-- END NAVBAR -->
    <p id="pageStatus">No Current Status</p>
    <!-- Buttons ================================================== -->
    <div class="container">
      <br />
      <p hidden id="p1" class="bs-component">
        <button id="b1" type="button" class="btn btn-default btn-lg btn-block" onclick="requestIO(1,'b');">BUTTON 1</button>
      </p>
      <p hidden id="p2" class="bs-component">
        <button id="b2" type="button" class="btn btn-default btn-lg btn-block" onclick="requestIO(2,'b');">BUTTON 2</button>
      </p>
      <p hidden id="p3" class="bs-component">
        <button id="b3" type="button" class="btn btn-default btn-lg btn-block" onclick="requestIO(3,'b');">BUTTON 3</button>
      </p>
      <p hidden id="p4" class="bs-component">
        <button id="b4" type="button" class="btn btn-default btn-lg btn-block" onclick="requestIO(4,'b');">BUTTON 4</button>
      </p>
    </div>

</body>

</html>
